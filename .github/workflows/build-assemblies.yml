name: Build and Publish Game Assemblies

on:
  push:
    tags:
      - 'assemblies-v*'   # Trigger on assembly tags like assemblies-v1.4.4

permissions:
  contents: read
  packages: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-assemblies:
    name: Build and Publish Game Assemblies NuGet
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Extract Version from Tag
      id: version
      shell: pwsh
      run: |
        $tag = "${{ github.ref_name }}"
        if ($tag -match "assemblies-v(.+)") {
          $version = $matches[1]
          Write-Output "version=$version" >> $env:GITHUB_OUTPUT
          Write-Output "Game version: $version"
        } else {
          Write-Error "Invalid tag format. Expected: assemblies-vX.Y.Z"
          exit 1
        }
        
    - name: Check for Processed Assemblies
      id: check-assemblies
      shell: pwsh
      run: |
        $libExists = Test-Path "lib/net48/Assembly-CSharp.dll"
        $assembliesExist = $libExists -and (Test-Path "lib/net48/Assembly-CSharp-firstpass.dll")
        
        if (-not $assembliesExist) {
          Write-Output "‚ùå Processed assemblies not found in lib/net48/"
          Write-Output "üí° Run .\scripts\Process-Assemblies.ps1 -GameVersion ${{ steps.version.outputs.version }} first"
          exit 1
        }
        
        Write-Output "‚úÖ Found processed assemblies"
        
    - name: Update Package Version
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $content = Get-Content "GameAssemblies.nuspec.csproj" -Raw
        $content = $content -replace '<PackageVersion>.*</PackageVersion>', "<PackageVersion>$version</PackageVersion>"
        Set-Content "GameAssemblies.nuspec.csproj" $content
        Write-Output "Updated package version to $version"
        
    - name: Build NuGet Package
      shell: pwsh
      run: |
        dotnet pack GameAssemblies.nuspec.csproj --configuration Release --output ./nupkg
        $package = Get-ChildItem "./nupkg/*.nupkg" | Select-Object -First 1
        Write-Output "üì¶ Created: $($package.Name)"
        
    - name: Publish to GitHub Packages
      shell: pwsh
      run: |
        $package = Get-ChildItem "./nupkg/*.nupkg" | Select-Object -First 1
        Write-Output "Publishing package: $($package.Name)"
        Write-Output "Package size: $([math]::Round($package.Length / 1MB, 2)) MB"
        
        # Debug information
        Write-Output "Repository: ${{ github.repository }}"
        Write-Output "Actor: ${{ github.actor }}" 
        Write-Output "Repository Owner: ${{ github.repository_owner }}"
        
        # Add GitHub Packages source
        $sourceUrl = "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        Write-Output "Adding NuGet source: $sourceUrl"
        
        dotnet nuget add source --username "${{ github.actor }}" --password "${{ secrets.GITHUB_TOKEN }}" --store-password-in-clear-text --name github "$sourceUrl"
        
        # List configured sources
        Write-Output "Configured NuGet sources:"
        dotnet nuget list source
        
        # Push to GitHub Packages
        Write-Output "Pushing package to GitHub Packages..."
        dotnet nuget push "$($package.FullName)" --source "github" --skip-duplicate
        
        Write-Output "üöÄ Published to GitHub Packages"
        
    # Optional: Publish to NuGet.org (uncomment and add NUGET_API_KEY secret)
    # - name: Publish to NuGet.org
    #   if: github.repository_owner == 'MrPurple6411'
    #   shell: pwsh
    #   run: |
    #     $package = Get-ChildItem "./nupkg/*.nupkg" | Select-Object -First 1
    #     dotnet nuget push $package.FullName --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY }}
    #     Write-Output "üåç Published to NuGet.org"
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        PACKAGE_VERSION: ${{ steps.version.outputs.version }}
      with:
        tag_name: ${{ github.ref_name }}
        name: "Game Assemblies v${{ steps.version.outputs.version }}"
        body: |
          ## City of Gangsters Game Assemblies v${{ steps.version.outputs.version }}
          
          Publicized and stripped game assemblies for mod development.
          
          ### Installation
          ```xml
          <PackageReference Include="MrPurple6411.CityOfGangsters.GameAssemblies" Version="${{ env.PACKAGE_VERSION }}" />
          ```
          
          ### Changes
          - Game assemblies processed for version ${{ steps.version.outputs.version }}
          - All internal types publicized for Harmony patching
          - Assemblies stripped for reduced size
          
          ### Legal
          These assemblies are stripped and publicized for modding purposes only.
        files: |
          ./nupkg/*.nupkg
        prerelease: false