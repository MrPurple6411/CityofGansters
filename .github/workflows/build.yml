name: Build and Release Mods

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  push:
    tags:
      - 'v*'          # Global releases (v1.2.3)
      - '*-v*'         # Individual mod releases (ModName-v1.2.3)

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: 'CityofGangsters.sln'

jobs:
  # Detect which mods to build based on changes and tag type
  detect-changes:
    name: Detect Changed Mods
    runs-on: ubuntu-latest
    outputs:
      changed-mods: ${{ steps.changes.outputs.mods }}
      tag-type: ${{ steps.tag-info.outputs.type }}
      target-mod: ${{ steps.tag-info.outputs.mod }}
      version: ${{ steps.tag-info.outputs.version }}
      should-release: ${{ steps.tag-info.outputs.should-release }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Analyze Git Tag
      id: tag-info
      run: |
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          TAG_NAME="${{ github.ref_name }}"
          echo "Processing tag: $TAG_NAME"
          
          if [[ $TAG_NAME =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Global release: v1.2.3
            echo "type=global" >> $GITHUB_OUTPUT
            echo "version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
            echo "should-release=true" >> $GITHUB_OUTPUT
          elif [[ $TAG_NAME =~ ^(.+)-v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            # Individual mod: ModName-v1.2.3
            MOD_NAME="${BASH_REMATCH[1]}"
            VERSION="${BASH_REMATCH[2]}"
            echo "type=individual" >> $GITHUB_OUTPUT
            echo "mod=$MOD_NAME" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "should-release=true" >> $GITHUB_OUTPUT
          else
            echo "Invalid tag format: $TAG_NAME" >&2
            exit 1
          fi
        else
          echo "type=none" >> $GITHUB_OUTPUT
          echo "should-release=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Detect Changed Mods
      id: changes
      run: |
        if [[ "${{ steps.tag-info.outputs.type }}" == "global" ]]; then
          # Global tag: find all mods changed since last global tag
          LAST_GLOBAL_TAG=$(git describe --tags --abbrev=0 --match="v*" HEAD^ 2>/dev/null || echo "")
          if [[ -n "$LAST_GLOBAL_TAG" ]]; then
            CHANGED_FILES=$(git diff --name-only "$LAST_GLOBAL_TAG"..HEAD)
          else
            CHANGED_FILES=$(git diff --name-only HEAD~10..HEAD)  # fallback
          fi
        elif [[ "${{ steps.tag-info.outputs.type }}" == "individual" ]]; then
          # Individual tag: only build the specified mod
          echo "mods=${{ steps.tag-info.outputs.mod }}" >> $GITHUB_OUTPUT
          exit 0
        else
          # Regular commit: find changed files since last commit
          CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
        fi
        
        # Extract mod names from changed files in src/
        MODS=$(echo "$CHANGED_FILES" | grep "^src/" | cut -d'/' -f2 | sort -u | tr '\n' ' ' | sed 's/[[:space:]]*$//')
        echo "Changed mods: $MODS"
        echo "mods=$MODS" >> $GITHUB_OUTPUT

  # Create releases for tagged builds
  release:
    name: Create Releases
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.should-release == 'true'
    
    steps:
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: mod-packages-${{ github.sha }}
        path: zips/
        
    - name: Create Individual Mod Release
      if: needs.detect-changes.outputs.tag-type == 'individual'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "${{ needs.detect-changes.outputs.target-mod }} v${{ needs.detect-changes.outputs.version }}"
        body: |
          ## ${{ needs.detect-changes.outputs.target-mod }} v${{ needs.detect-changes.outputs.version }}
          
          Individual mod release for **${{ needs.detect-changes.outputs.target-mod }}**.
          
          ### Installation
          1. Download the ZIP file below
          2. Extract to your City of Gangsters directory
          3. Run the game once to initialize BepInEx
          
          ### Requirements
          - BepInEx 5.4.22 or later
          - City of Gangsters
        files: |
          zips/${{ needs.detect-changes.outputs.target-mod }}-v${{ needs.detect-changes.outputs.version }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Global Release
      if: needs.detect-changes.outputs.tag-type == 'global'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "City of Gangsters Mods v${{ needs.detect-changes.outputs.version }}"
        body: |
          ## City of Gangsters Mods v${{ needs.detect-changes.outputs.version }}
          
          Multi-mod release containing updates for:
          ${{ needs.detect-changes.outputs.changed-mods }}
          
          ### Installation
          1. Download the mod ZIP files you want below
          2. Extract each to your City of Gangsters directory
          3. Run the game once to initialize BepInEx
          
          ### Requirements
          - BepInEx 5.4.22 or later
          - City of Gangsters
        files: |
          zips/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }