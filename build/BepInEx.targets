<Project>
  <!-- BepInX Dependencies -->
  <ItemGroup>
    <PackageReference Include="BepInEx.Core" Version="$(BepInExVersion)" PrivateAssets="all" />
    <PackageReference Include="BepInEx.PluginInfoProps" Version="2.1.0" PrivateAssets="all" />
    <PackageReference Include="UnityEngine.Modules" Version="2020.3.48" PrivateAssets="all" />
  </ItemGroup>

  <!-- Game Assembly References -->
  <!-- Priority: NuGet package first, fallback to local assemblies -->
  <ItemGroup Condition="'$(UseLocalGameAssemblies)' != 'true'">
    <PackageReference Include="MrPurple6411.CityOfGangsters.GameAssemblies" Version="1.0.0" PrivateAssets="all" />
  </ItemGroup>

  <ItemGroup Condition="'$(UseLocalGameAssemblies)' == 'true' AND Exists('$(ManagedDir)')">
    <Reference Include="Assembly-CSharp" HintPath="$(ManagedDir)\Assembly-CSharp.dll" Private="false" />
    <Reference Include="Assembly-CSharp-firstpass" HintPath="$(ManagedDir)\Assembly-CSharp-firstpass.dll" Private="false" />
    <Reference Include="Unity.Timeline" HintPath="$(ManagedDir)\Unity.Timeline.dll" Private="false" />
    <Reference Include="Unity.TextMeshPro" HintPath="$(ManagedDir)\Unity.TextMeshPro.dll" Private="false" />
    <Reference Include="Unity.Postprocessing.Runtime" HintPath="$(ManagedDir)\Unity.Postprocessing.Runtime.dll" Private="false" />
    <Reference Include="Steamworks.NET" HintPath="$(ManagedDir)\Steamworks.NET.dll" Private="false" />
  </ItemGroup>

  <!-- Build Targets -->
  <Target Name="CopyToPluginsFolder" AfterTargets="Build" Condition="'$(Configuration)' == 'Debug'">
    <PropertyGroup>
      <PluginsDirExists>false</PluginsDirExists>
      <PluginsDirExists Condition="Exists('$(PluginsDir)')">true</PluginsDirExists>
    </PropertyGroup>
    
    <Message Text="Debug build: Attempting to copy to game plugins folder" Importance="normal" />
    <Message Text="Plugins directory: $(PluginsDir)" Importance="normal" />
    <Message Text="Plugins directory exists: $(PluginsDirExists)" Importance="normal" />
    
    <Copy SourceFiles="$(OutputPath)$(AssemblyName).dll" DestinationFolder="$(PluginsDir)" ContinueOnError="true" Condition="'$(PluginsDirExists)' == 'true'" />
    <Copy SourceFiles="$(OutputPath)$(AssemblyName).pdb" DestinationFolder="$(PluginsDir)" ContinueOnError="true" Condition="'$(PluginsDirExists)' == 'true' AND Exists('$(OutputPath)$(AssemblyName).pdb')" />
    
    <Message Text="Successfully copied $(AssemblyName).dll to game plugins folder" Importance="high" Condition="'$(PluginsDirExists)' == 'true'" />
    <Warning Text="Could not find BepInEx plugins directory: $(PluginsDir). Install BepInEx and run the game once to create the directory." Condition="'$(PluginsDirExists)' == 'false'" />
  </Target>

  <Target Name="CreateModPackage" AfterTargets="Build" Condition="'$(Configuration)' == 'Release' OR '$(CreatePackage)' == 'true'">
    <PropertyGroup>
      <ZipOutputDir Condition="'$(SolutionDir)' != ''">$(SolutionDir)Zips_CityofGangsters</ZipOutputDir>
      <ZipOutputDir Condition="'$(SolutionDir)' == ''">$(MSBuildProjectDirectory)\..\..\Zips_CityofGangsters</ZipOutputDir>
      <ModStagingDir>$(ZipOutputDir)\$(MSBuildProjectName)</ModStagingDir>
      <BepInExPluginsDir>$(ModStagingDir)\BepInEx\plugins</BepInExPluginsDir>
    </PropertyGroup>
    
    <!-- Create BepInEx-compatible folder structure -->
    <MakeDir Directories="$(BepInExPluginsDir)" />
    
    <!-- Copy main DLL -->
    <Copy SourceFiles="$(OutputPath)$(AssemblyName).dll" DestinationFolder="$(BepInExPluginsDir)" />
    
    <!-- Copy documentation if available -->
    <Copy SourceFiles="$(MSBuildProjectDirectory)\README.md" DestinationFolder="$(ModStagingDir)" Condition="Exists('$(MSBuildProjectDirectory)\README.md')" />
    <Copy SourceFiles="$(MSBuildProjectDirectory)\CHANGELOG.md" DestinationFolder="$(ModStagingDir)" Condition="Exists('$(MSBuildProjectDirectory)\CHANGELOG.md')" />
    
    <!-- Create version-tagged ZIP -->
    <PropertyGroup>
      <ZipFileName>$(MSBuildProjectName)-v$(PluginVersion).zip</ZipFileName>
      <ZipFullPath>$(ZipOutputDir)\$(ZipFileName)</ZipFullPath>
    </PropertyGroup>
    
    <Message Text="Creating mod package: $(ZipFullPath)" Importance="high" />
    <Exec Command="powershell -Command &quot;if (Test-Path '$(ZipFullPath)') { Remove-Item '$(ZipFullPath)' -Force }; Compress-Archive -Path '$(ModStagingDir)\*' -DestinationPath '$(ZipFullPath)' -CompressionLevel Optimal&quot;" />
    
    <!-- Clean up staging directory -->
    <RemoveDir Directories="$(ModStagingDir)" />
    
    <Message Text="Successfully created: $(ZipFileName)" Importance="high" />
  </Target>

  <!-- Debugging Support -->
  <Target Name="StartGame" Condition="Exists('$(GameDir)\CoG.exe')">
    <Message Text="Starting City of Gangsters from $(GameDir)" Importance="high" />
    <Exec Command="&quot;$(GameDir)\CoG.exe&quot;" ContinueOnError="true" WorkingDirectory="$(GameDir)" />
  </Target>

  <!-- Assembly processing is handled by local scripts -->
  <!-- Use: .\scripts\Process-Assemblies.ps1 -GameVersion "1.0.0" -->
  
  <!-- Build Validation -->
  <Target Name="ValidateBuild" AfterTargets="Build">
    <Message Text="=== Build Summary for $(MSBuildProjectName) ===" Importance="high" />
    <Message Text="Plugin GUID: $(PluginGuid)" Importance="high" />
    <Message Text="Plugin Version: $(PluginVersion)" Importance="high" />
    <Message Text="Output: $(OutputPath)$(AssemblyName).dll" Importance="high" />
    <Message Text="Git Tag: $(GitTag)" Importance="normal" Condition="'$(GitTag)' != ''" />
    <Message Text="========================================" Importance="high" />
  </Target>
</Project>